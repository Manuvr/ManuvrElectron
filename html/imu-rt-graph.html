<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <style>
    body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }

    .graph .axis {
        stroke-width: 1;
    }

    .graph .axis .tick line {
        stroke: black;
    }

    .graph .axis .tick text {
        fill: black;
        font-size: 0.7em;
    }

    .graph .axis .domain {
        fill: none;
        stroke: black;
    }

    .graph .group {
        fill: none;
        stroke: black;
        stroke-width: 1.5;
    }
    </style>
    
    <script src='js/d3.v3.min.js'></script>
    <script src='../bower_components/socket.io-client/socket.io.js'></script>
    <script src='node_modules/jquery/dist/jquery.min.js'></script>

  </head>
  <body>
    <header>Manuvr Real Time IMU Monitor</header>
    <div>
      <select id='phalanx-select'>
        <option value='CARPALS'>Carpals</option>
        <option value='METACARPALS'>Metacarpals</option>
        <option value='PP_1'>PP_1</option>
        <option value='IP_1'>IP_1</option>
        <option value='DP_1'>DP_1</option>
        <option value='PP_2'>PP_2</option>
        <option value='IP_2'>IP_2</option>
        <option value='DP_2'>DP_2</option>
        <option value='PP_3'>PP_3</option>
        <option value='IP_3'>IP_3</option>
        <option value='DP_3'>DP_3</option>
        <option value='PP_4'>PP_4</option>
        <option value='IP_4'>IP_4</option>
        <option value='DP_4'>DP_4</option>
        <option value='PP_5'>PP_5</option>
        <option value='IP_5'>IP_5</option>
        <option value='DP_5'>DP_5</option>
      </select>
    </div>
    <br /><br />
    <div class='graph'></div>

    <script>

    // Set dropdown vars
    var phalanaxSelected = 'CARPALS';
    $('#phalanx-select').change(function() {
      phalanaxSelected = $(this).val();
    });

    var titleLookup = {
      acc: 'Acceleration',
      gyro: 'Gyroscope',
      mag: 'Magnetometer'
    }

    var gm;
    var socket = io.connect();

    function runSocket() {
      socket.on('glove_update', function(data) {
        gm = data.IMU_set;
        console.log("got glove model");
      });
    }
    runSocket();

    function visualize(vectorSelected, yMax, yMin) {

      var limit = 60 * 1,
          duration = 80,
          now = new Date(Date.now() - duration);

      var groups = {
        x: {
          value: 0,
          color: 'orange',
          data: d3.range(limit).map(function() {
              return 0
          })
        },
        y: {
          value: 0,
          color: 'green',
          data: d3.range(limit).map(function() {
              return 0
          })
        },
        z: {
          value: 0,
          color: 'grey',
          data: d3.range(limit).map(function() {
              return 0
          })
        }
      }
      
      var margin = {top: 40, right: 20, bottom: 40, left: 50},
        width = 960 - margin.left - margin.right,
        height = 200 - margin.top - margin.bottom;

      var x = d3.time.scale()
        .domain([now - (limit - 2), now - duration])
        .range([0, width]);

      var y = d3.scale.linear()
        .domain([yMin, yMax])
        .range([height, 0]);

      var line = d3.svg.line()
        .interpolate('basis')
        .x(function(d, i) {
            return x(now - (limit - 1 - i) * duration)
        })
        .y(function(d) {
            return y(d)
        });

      var svg = d3.select('.graph').append('svg')
        .attr('class', 'chart')
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var graph_title = svg.append('text')
        .attr('x', 1)
        .attr('y', 0 - (margin.top / 2))
        .attr('text-anchor', 'middle')
        .style('font-size', '15px')
        .text(titleLookup[vectorSelected]);

      var axis_x = svg.append('g')
        .attr('class', 'x axis')
        .attr('transform', 'translate(0,' + height + ')')
        .call(x.axis = d3.svg.axis().scale(x).orient('bottom'));
      
      var axis_y = svg.append('g')
        .attr('class', 'y axis')
        .call(y.axis = d3.svg.axis().scale(y).orient('left'));

      var paths = svg.append('g');

      for (var name in groups) {
        var group = groups[name];
        group.path = paths.append('path')
          .data([group.data])
          .attr('class', name + ' group')
          .style('stroke', group.color);
      }

      function tick() {
        now = new Date();
        // Update lines with IMU vals
        var i = 0;
        for (var name in groups) {
          var group = groups[name];
          if(gm) {
            group.data.push(gm[phalanaxSelected][vectorSelected][name])
            group.path.attr('d', line)
          }
          else {
            group.data.push(0);
            group.path.attr('d', line)
          }
          i++;
        }

        // Shift domain
        x.domain([now - (limit - 2) * duration, now - duration])

        // Slide x-axis left
        axis_x.transition()
          .duration(duration)
          .ease('linear')
          .call(x.axis);

        // Slide paths left
        paths.attr('transform', null)
          .transition()
          .duration(duration)
          .ease('linear')
          .attr('transform', 'translate(' + x(now - (limit - 1) * duration) + ')')
          .each('end', tick);

        // Remove oldest data point from each group
        for (var name in groups) {
            var group = groups[name];
            group.data.shift();
        }
      }

      tick()
    }

    visualize('acc', -2, 2);
    visualize('gyro', -400, 400);
    visualize('mag', -3, 3);
    </script>
  </body>
</html>
